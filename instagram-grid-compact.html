<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Grid Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: transparent;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: transparent;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            padding: 0;
        }

        .grid-item {
            position: relative;
            padding-bottom: 100%;
            background: #f0f0f0;
            overflow: hidden;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .grid-item:hover {
            opacity: 0.9;
        }

        .grid-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .grid-item.no-content {
            background: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
        }

        .grid-item.no-content::before {
            content: 'No Content';
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #999;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 40px 20px;
            color: #ed4956;
            font-size: 13px;
            background: #fff5f5;
            border-radius: 4px;
            margin: 10px;
        }

        /* Bot√£o de refresh */
        .refresh-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: rgba(0, 0, 0, 0.85);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .grid {
                gap: 2px;
            }
        }
    </style>
</head>
<body>
    <button class="refresh-btn" onclick="init()" id="refreshBtn">
        üîÑ Refresh
    </button>

    <div class="container">
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Carregando publica√ß√µes...</p>
            </div>
        </div>
    </div>

    <script>
        // ===================================
        // CONFIGURA√á√ÉO - EDITE AQUI
        // ===================================
        const CONFIG = {
            NOTION_TOKEN: 'ntn_C61435754894zYhL4mCru5xWUKvRjU1KsNtfvcJg6eM4wq', // Cole seu token aqui
            DATABASE_URL: 'https://www.notion.so/mobrand/056dee5facf54bc3b7b4348ff66bb34c?v=e9f19d07ed8543158236f1b59f81d68d&pvs=23', // Cole a URL do seu banco de dados aqui
            GRID_COLUMNS: 3, // N√∫mero de colunas (3 = padr√£o Instagram)
            GRID_GAP: 4, // Espa√ßamento entre posts em pixels
            MAX_POSTS: 9 // Limite de posts a exibir (deixe null para todos)
        };

        // Extrai o Database ID da URL do Notion
        function extractDatabaseId(url) {
            // Formato: https://www.notion.so/workspace/{DATABASE_ID}?v=...
            const match = url.match(/\/([a-f0-9]{32})/);
            return match ? match[1] : null;
        }

        // Busca dados do Notion
        async function fetchNotionData() {
            const databaseId = extractDatabaseId(CONFIG.DATABASE_URL);
            
            if (!databaseId) {
                throw new Error('URL do banco de dados inv√°lida');
            }

            const response = await fetch(`https://api.notion.com/v1/databases/${databaseId}/query`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.NOTION_TOKEN}`,
                    'Notion-Version': '2022-06-28',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sorts: [
                        {
                            property: 'Publish Date',
                            direction: 'descending'
                        }
                    ],
                    page_size: CONFIG.MAX_POSTS || 100
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Erro ao buscar dados do Notion');
            }

            return await response.json();
        }

        // Processa as propriedades do Notion
        function processNotionPage(page) {
            const props = page.properties;
            
            return {
                id: page.id,
                name: props.Name?.title?.[0]?.plain_text || 'Sem t√≠tulo',
                publishDate: props['Publish Date']?.date?.start || null,
                attachment: props.Attachment?.files?.[0]?.file?.url || props.Attachment?.files?.[0]?.external?.url || null,
                imageSource: props['*Image Source']?.select?.name || 'Anexo de imagem',
                link: props['*Link']?.rich_text?.[0]?.plain_text || null,
                canvaLink: props['*Canva Link']?.url || null
            };
        }

        // Determina a URL da imagem baseado na fonte
        function getImageUrl(post) {
            switch (post.imageSource) {
                case 'Anexo de imagem':
                    return post.attachment;
                case 'Link':
                    return post.link;
                case 'Design em tela':
                    return post.canvaLink;
                default:
                    return post.attachment || post.link || post.canvaLink;
            }
        }

        // Cria o grid de posts
        function createGrid(posts) {
            const content = document.getElementById('content');
            const grid = document.createElement('div');
            grid.className = 'grid';
            
            // Aplica configura√ß√µes de layout
            grid.style.gridTemplateColumns = `repeat(${CONFIG.GRID_COLUMNS}, 1fr)`;
            grid.style.gap = `${CONFIG.GRID_GAP}px`;

            // Limita n√∫mero de posts se configurado
            const displayPosts = CONFIG.MAX_POSTS ? posts.slice(0, CONFIG.MAX_POSTS) : posts;

            displayPosts.forEach(post => {
                const item = document.createElement('div');
                item.className = 'grid-item';

                const imageUrl = getImageUrl(post);

                if (imageUrl) {
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = post.name;
                    img.loading = 'lazy';
                    img.onerror = function() {
                        this.parentElement.classList.add('no-content');
                        this.style.display = 'none';
                    };
                    item.appendChild(img);
                } else {
                    item.classList.add('no-content');
                }

                grid.appendChild(item);
            });

            // Preenche espa√ßos vazios para completar a √∫ltima linha
            const totalCells = Math.ceil(displayPosts.length / CONFIG.GRID_COLUMNS) * CONFIG.GRID_COLUMNS;
            const emptyCells = totalCells - displayPosts.length;
            
            for (let i = 0; i < emptyCells; i++) {
                const empty = document.createElement('div');
                empty.className = 'grid-item no-content';
                grid.appendChild(empty);
            }

            content.innerHTML = '';
            content.appendChild(grid);
        }

        // Mostra erro
        function showError(message) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="error">
                    <p><strong>‚ùå Erro ao carregar</strong></p>
                    <p style="margin-top: 8px; font-size: 12px;">${message}</p>
                    <p style="margin-top: 8px; font-size: 11px; color: #999;">
                        Verifique o token e a URL do banco de dados.
                    </p>
                </div>
            `;
        }

        // Mostra loading
        function showLoading() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Carregando...</p>
                </div>
            `;
        }

        // Inicializa o widget
        async function init() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ Carregando...';

            try {
                showLoading();
                const data = await fetchNotionData();
                const posts = data.results.map(processNotionPage);
                
                if (posts.length === 0) {
                    showError('Nenhuma publica√ß√£o encontrada no banco de dados.');
                } else {
                    createGrid(posts);
                }
            } catch (error) {
                console.error('Erro:', error);
                showError(error.message);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'üîÑ Refresh';
            }
        }

        // Carrega ao iniciar
        init();

        // Atualiza automaticamente a cada 5 minutos
        setInterval(init, 5 * 60 * 1000);
    </script>
</body>
</html>
